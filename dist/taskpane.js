/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={58394:function(e,n,t){"use strict";e.exports=t.p+"34dba35fef813ba6b03a.css"},98362:function(e,n,t){"use strict";e.exports=t.p+"assets/logo-filled.png"}},n={};function t(r){var o=n[r];if(void 0!==o)return o.exports;var a=n[r]={exports:{}};return e[r](a,a.exports,t),a.exports}t.m=e,t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},function(){var e;t.g.importScripts&&(e=t.g.location+"");var n=t.g.document;if(!e&&n&&(n.currentScript&&"SCRIPT"===n.currentScript.tagName.toUpperCase()&&(e=n.currentScript.src),!e)){var r=n.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e}(),t.b=document.baseURI||self.location.href,function(){function e(){var t,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",c=o.toStringTag||"@@toStringTag";function s(e,o,a,c){var s=o&&o.prototype instanceof l?o:l,u=Object.create(s.prototype);return n(u,"_invoke",function(e,n,o){var a,c,s,l=0,u=o||[],d=!1,g={p:0,n:0,v:t,a:p,f:p.bind(t,4),d:function(e,n){return a=e,c=0,s=t,g.n=n,i}};function p(e,n){for(c=e,s=n,r=0;!d&&l&&!o&&r<u.length;r++){var o,a=u[r],p=g.p,f=a[2];e>3?(o=f===n)&&(s=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=t):a[0]<=p&&((o=e<2&&p<a[1])?(c=0,g.v=n,g.n=a[1]):p<f&&(o=e<3||a[0]>n||n>f)&&(a[4]=e,a[5]=n,g.n=f,c=0))}if(o||e>1)return i;throw d=!0,n}return function(o,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&p(u,f),c=u,s=f;(r=c<2?t:s)||!d;){a||(c?c<3?(c>1&&(g.n=-1),p(c,s)):g.n=s:g.v=s);try{if(l=2,a){if(c||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,c<2&&(c=0)}else 1===c&&(r=a.return)&&r.call(a),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=t}else if((r=(d=g.n<0)?s:e.call(n,g))!==i)break}catch(e){a=t,c=1,s=e}finally{l=1}}return{value:r,done:d}}}(e,a,c),!0),u}var i={};function l(){}function u(){}function d(){}r=Object.getPrototypeOf;var g=[][a]?r(r([][a]())):(n(r={},a,function(){return this}),r),p=d.prototype=l.prototype=Object.create(g);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,n(e,c,"GeneratorFunction")),e.prototype=Object.create(p),e}return u.prototype=d,n(p,"constructor",d),n(d,"constructor",u),u.displayName="GeneratorFunction",n(d,c,"GeneratorFunction"),n(p),n(p,c,"Generator"),n(p,a,function(){return this}),n(p,"toString",function(){return"[object Generator]"}),(e=function(){return{w:s,m:f}})()}function n(e,t,r,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}n=function(e,t,r,o){function c(t,r){n(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[t]=r:(c("next",0),c("throw",1),c("return",2))},n(e,t,r,o)}function t(e,n,t,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void t(e)}s.done?n(i):Promise.resolve(i).then(r,o)}function r(e){return function(){var n=this,r=arguments;return new Promise(function(o,a){var c=e.apply(n,r);function s(e){t(c,o,a,s,i,"next",e)}function i(e){t(c,o,a,s,i,"throw",e)}s(void 0)})}}var o="https://insyncai.duckdns.org",a="InSync API",c="Guidance",s=!1,i=!1,l=!1,u=!1,d=null,g=[],p=null;function f(){return(f=r(e().m(function n(){var t,r;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,fetch("".concat(o,"/api/login"),{method:"GET",headers:{Authorization:"Basic ".concat(p)}});case 1:return t=e.v,e.a(2,t.ok);case 2:return e.p=2,r=e.v,console.error("Verification error:",r),e.a(2,!1)}},n,null,[[0,2]])}))).apply(this,arguments)}function h(){console.log("Logging out user...");try{localStorage.removeItem("userCredentials"),localStorage.removeItem("username"),localStorage.removeItem("userEmail"),sessionStorage.removeItem("chatSessionId"),sessionStorage.removeItem("conversationHistory"),console.log("Credentials cleared, redirecting to login page"),window.location.href="login.html"}catch(e){console.error("Error during logout cleanup:",e),window.location.href="login.html"}}function m(){return(m=r(e().m(function n(){var t,r,o;return e().w(function(e){for(;;)switch(e.n){case 0:return b(),y(),document.getElementById("send-btn").addEventListener("click",A),document.getElementById("user-input").addEventListener("keypress",function(e){"Enter"!==e.key||i||A()}),document.getElementById("clear-chat-btn").addEventListener("click",S),document.getElementById("logout-btn").addEventListener("click",v),t=document.getElementById("menu-toggle"),r=document.getElementById("dropdown-content"),t.addEventListener("click",function(e){e.stopPropagation(),r.classList.toggle("show")}),document.addEventListener("click",function(e){t.contains(e.target)||r.contains(e.target)||r.classList.remove("show")}),o=localStorage.getItem("username")||"User",R("Welcome ".concat(o,"! I'll help you analyze your Excel data."),"assistant"),e.n=1,P();case 1:return e.a(2)}},n)}))).apply(this,arguments)}function y(){var e=document.getElementById("user-info"),n=localStorage.getItem("username")||"User";e&&(e.textContent="Logged in as: ".concat(n),e.style.display="block")}function v(){return w.apply(this,arguments)}function w(){return(w=r(e().m(function n(){var t;return e().w(function(e){for(;;)switch(e.n){case 0:console.log("Logout button clicked");try{t=confirm("Are you sure you want to logout?"),console.log("Confirmation result:",t),t&&h()}catch(e){console.error("Error during logout:",e),h()}case 1:return e.a(2)}},n)}))).apply(this,arguments)}function b(){var e=sessionStorage.getItem("chatSessionId"),n=sessionStorage.getItem("conversationHistory");if(e&&n){d=e;try{g=JSON.parse(n),console.log("Restored session: ".concat(d," with ").concat(g.length," messages")),x(),g.forEach(function(e){e.content&&e.role&&R(e.content,e.role)})}catch(e){console.error("Failed to restore history:",e),E()}}else E()}function E(){d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"===e?n:3&n|8).toString(16)}),g=[],sessionStorage.setItem("chatSessionId",d),sessionStorage.setItem("conversationHistory",JSON.stringify([])),console.log("Created new session: ".concat(d)),x()}function k(e){if(!e||"string"!=typeof e)return"Processing error occurred. Please try again.";var n=e.toLowerCase();return n.includes("gemini")||n.includes("google")||n.includes("generative")||n.includes("model")||n.includes("api key")||n.includes("quota")||n.includes("rate limit")||n.includes("safety")||n.includes("blocked")||n.includes("function call")||n.includes("tool")?"InSync AI processing error. Please try again later or rephrasing your question.":n.includes("server")||n.includes("backend")||n.includes("fastapi")||n.includes("internal server error")||n.includes("500")||n.includes("503")||n.includes("timeout")?"Service temporarily unavailable. Please try again in a moment.":n.includes("network")||n.includes("connection")||n.includes("fetch")||n.includes("cors")||n.includes("refused")?"Connection error. Please check your network and try again.":n.includes("unauthorized")||n.includes("forbidden")||n.includes("401")||n.includes("403")?"Access denied. Please contact support.":n.includes("json")||n.includes("parse")||n.includes("syntax")||n.includes("invalid")?"Data processing error. Please try again.":n.includes("exception")||n.includes("traceback")||n.includes("error:")||n.includes("failed to")?"Processing error occurred. Please try again.":e.length>100?"InSync AI encountered an issue. Please try again later or rephrasing your question.":e}function x(){var e=document.getElementById("context-indicator");if(e){var n=g.length;n>0?(e.textContent="".concat(n," messages"),e.style.display="block"):e.style.display="none"}}function I(){try{sessionStorage.setItem("conversationHistory",JSON.stringify(g))}catch(e){console.error("Failed to save conversation history:",e)}}function S(){return C.apply(this,arguments)}function C(){return(C=r(e().m(function n(){var t,r,a,c,s;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,_("Clearing chat history...","info"),e.p=1,e.n=2,fetch("".concat(o,"/api/session/reset"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic ".concat(p)},body:JSON.stringify({sessionId:d})});case 2:return t=e.v,e.n=3,t.json();case 3:r=e.v,console.log("Session reset:",r.message),console.log("Embeddings preserved:",r.embeddingsPreserved),e.n=5;break;case 4:e.p=4,c=e.v,console.warn("Could not reset server session:",c);case 5:document.getElementById("chat-container").innerHTML="",g=[],I(),x(),R("Chat history cleared. Embeddings preserved. How can I help you?","assistant"),_("Ready - Chat cleared","success"),e.n=7;break;case 6:e.p=6,s=e.v,console.error("Error clearing conversation:",s),a=k(s.message),_("Error: ".concat(a),"error");case 7:return e.a(2)}},n,null,[[1,4],[0,6]])}))).apply(this,arguments)}function P(){return T.apply(this,arguments)}function T(){return(T=r(e().m(function n(){var t,r,o,a;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,_("Loading data sheets...","info"),e.n=1,O();case 1:return t=e.v,e.n=2,B();case 2:if(r=e.v,!t&&!r){e.n=3;break}s=!0,_("Ready! All data loaded","success"),R("Data embeddings loaded successfully. What would you like to know?","assistant"),$(),e.n=4;break;case 3:throw new Error("Failed to load data sheets");case 4:e.n=6;break;case 5:e.p=5,a=e.v,console.error("Error loading sheets:",a),_("Failed to load data","error"),o=k(a.message),R("Error: ".concat(o),"error");case 6:return e.a(2)}},n,null,[[0,5]])}))).apply(this,arguments)}function O(){return L.apply(this,arguments)}function L(){return L=r(e().m(function n(){var t;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:if(!l){n.n=1;break}return console.log("InSync API embeddings already loaded, skipping..."),n.a(2,!0);case 1:return n.p=1,console.log("Loading InSync API sheet..."),n.n=2,Excel.run(function(){var n=r(e().m(function n(t){var r,c,s,i,u,g,f,h,m,y,v,w,b;return e().w(function(e){for(;;)switch(e.n){case 0:return(r=t.workbook.worksheets).load("items/name"),e.n=1,t.sync();case 1:if(c=r.items.find(function(e){return e.name===a})){e.n=2;break}throw new Error('Sheet "'.concat(a,'" not found. Please ensure you have a sheet named "').concat(a,'".'));case 2:if(s=r.items.find(function(e){return"Model"===e.name}),i=null,!s){e.n=4;break}return(u=s.getRange("A1")).load("values"),e.n=3,t.sync();case 3:(i=u.values[0][0])&&"string"==typeof i&&""!==i.trim()?(i=i.trim().toUpperCase(),console.log("Found ticker: ".concat(i))):(i=null,console.log("No ticker found in Model!A1")),e.n=5;break;case 4:console.log("Model sheet not found, proceeding without ticker");case 5:return(g=c.getUsedRange()).load(["values","address"]),e.n=6,t.sync();case 6:return f=g.values,h=g.address,console.log("Read ".concat(f.length," rows from ").concat(a)),m=f[6]||[],e.n=7,fetch("".concat(o,"/api/embeddings/create-from-data?session_id=").concat(d),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic ".concat(p)},body:JSON.stringify({worksheetName:a,data:f,headers:m,ticker:i,metadata:{totalRows:f.length,totalCols:m.length,address:h}})});case 7:if((y=e.v).ok){e.n=9;break}return e.n=8,y.json();case 8:throw v=e.v,w=v.detail||"Failed to create embeddings",new Error(k(w));case 9:return e.n=10,y.json();case 10:b=e.v,console.log("InSync API embeddings result:",b),l=!0;case 11:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 2:return n.a(2,!0);case 3:return n.p=3,t=n.v,console.error("Error loading InSync API sheet:",t),n.a(2,!1)}},n,null,[[1,3]])})),L.apply(this,arguments)}function B(){return j.apply(this,arguments)}function j(){return j=r(e().m(function n(){var t;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:if(!u){n.n=1;break}return console.log("Guidance embeddings already loaded, skipping..."),n.a(2,!0);case 1:return n.p=1,console.log("Loading Guidance sheet..."),n.n=2,Excel.run(function(){var n=r(e().m(function n(t){var r,a,s,i,l,g,f,h,m,y,v,w,b;return e().w(function(e){for(;;)switch(e.n){case 0:return(r=t.workbook.worksheets).load("items/name"),e.n=1,t.sync();case 1:if(a=r.items.find(function(e){return e.name===c})){e.n=2;break}throw new Error('Sheet "'.concat(c,'" not found. Please ensure you have a sheet named "').concat(c,'".'));case 2:if(s=r.items.find(function(e){return"Model"===e.name}),i=null,!s){e.n=4;break}return(l=s.getRange("A1")).load("values"),e.n=3,t.sync();case 3:(i=l.values[0][0])&&"string"==typeof i&&""!==i.trim()?(i=i.trim().toUpperCase(),console.log("Found ticker: ".concat(i))):(i=null,console.log("No ticker found in Model!A1")),e.n=5;break;case 4:console.log("Model sheet not found, proceeding without ticker");case 5:return(g=a.getUsedRange()).load(["values","address"]),e.n=6,t.sync();case 6:return f=g.values,h=g.address,console.log("Read ".concat(f.length," rows from ").concat(c)),m=f[6]||[],e.n=7,fetch("".concat(o,"/api/embeddings/create-from-data?session_id=").concat(d),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic ".concat(p)},body:JSON.stringify({worksheetName:c,data:f,headers:m,ticker:i,metadata:{totalRows:f.length,totalCols:m.length,address:h}})});case 7:if((y=e.v).ok){e.n=9;break}return e.n=8,y.json();case 8:throw v=e.v,w=v.detail||"Failed to create embeddings",new Error(k(w));case 9:return e.n=10,y.json();case 10:b=e.v,console.log("Guidance embeddings result:",b),u=!0;case 11:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 2:return n.a(2,!0);case 3:return n.p=3,t=n.v,console.error("Error loading Guidance sheet:",t),n.a(2,!1)}},n,null,[[1,3]])})),j.apply(this,arguments)}function A(){return N.apply(this,arguments)}function N(){return(N=r(e().m(function n(){var t,r,c,l,u,f,h,m,y,v,w;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!i&&s){e.n=1;break}return e.a(2);case 1:if(t=document.getElementById("user-input"),r=t.value.trim()){e.n=2;break}return e.a(2);case 2:return t.value="",R(r,"user"),c={role:"user",content:r,timestamp:Date.now()},g.push(c),I(),x(),i=!0,M(),F(!0),_("Analyzing...","info"),e.p=3,l=document.getElementById("chart-toggle").checked,console.log("📊 Charts toggle state: ".concat(l)),e.n=4,fetch("".concat(o,"/api/chat"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Basic ".concat(p)},body:JSON.stringify({question:r,sessionId:d,excelData:{worksheetName:a,data:[],headers:[]},conversationHistory:g,enableCharts:l})});case 4:if((u=e.v).ok){e.n=6;break}return e.n=5,u.json();case 5:throw f=e.v,h=f.detail||"Request failed",new Error(k(h));case 6:return e.n=7,u.json();case 7:m=e.v,console.log("Response:",m),R(m.answer,"assistant"),y={role:"assistant",content:m.answer,timestamp:Date.now(),hasChart:m.hasChart||!1},g.push(y),I(),x(),m.hasChart&&m.chartHtml&&H(m.chartHtml),void 0!==m.contextLength&&console.log("Server context length: ".concat(m.contextLength," messages")),_("Ready","success"),e.n=9;break;case 8:e.p=8,w=e.v,console.error("Error:",w),v=k(w.message),R("Error: ".concat(v),"error"),_("Error occurred","error");case 9:return e.p=9,i=!1,$(),F(!1),t.focus(),e.f(9);case 10:return e.a(2)}},n,null,[[3,8,9,10]])}))).apply(this,arguments)}function R(e,n){var t=document.getElementById("chat-container"),r=document.createElement("div");r.className="message message-".concat(n);var o=document.createElement("div");o.className="message-content","assistant"===n?o.innerHTML=function(e){var n=e;return n=n.replace(/```(\w+)?\n([\s\S]*?)```/g,function(e,n,t){return'<pre><code class="language-'.concat(n||"text",'">').concat(function(e){var n=document.createElement("div");return n.textContent=e,n.innerHTML}(t.trim()),"</code></pre>")}),n=(n=n.replace(/`([^`]+)`/g,function(e,n){return"<code>".concat(n,"</code>")})).replace(/\*\*([^*]+?)\*\*/g,function(e,n){return"<strong>".concat(n,"</strong>")}),n=n.replace(/__([^_]+?)__/g,function(e,n){return"<strong>".concat(n,"</strong>")}),n=n.replace(/(\s|^)\*([^\s*][^*]*?)\*(\s|$|[.,!?;:])/g,function(e,n,t,r){return"".concat(n,"<em>").concat(t,"</em>").concat(r)}),n=n.replace(/(\s|^)_([^\s_][^_]*?)_(\s|$|[.,!?;:])/g,function(e,n,t,r){return"".concat(n,"<em>").concat(t,"</em>").concat(r)}),n=n.replace(/^### (.+)$/gm,function(e,n){return"<h3>".concat(n,"</h3>")}),n=n.replace(/^## (.+)$/gm,function(e,n){return"<h2>".concat(n,"</h2>")}),n=n.replace(/^# (.+)$/gm,function(e,n){return"<h1>".concat(n,"</h1>")}),n=n.replace(/^\* (.+)$/gm,function(e,n){return"<li>".concat(n,"</li>")}),n=n.replace(/^- (.+)$/gm,function(e,n){return"<li>".concat(n,"</li>")}),n=(n=n.replace(/(<li>.*<\/li>\n?)+/g,function(e){return"<ul>".concat(e,"</ul>")})).replace(/^\d+\. (.+)$/gm,function(e,n){return"<li>".concat(n,"</li>")}),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,function(e,n,t){return'<a href="'.concat(t,'" target="_blank">').concat(n,"</a>")}),n=(n=n.replace(/\n\n/g,"</p><p>")).replace(/\n/g,"<br>"),(n=(n=(n=(n=(n=(n=(n="<p>".concat(n,"</p>")).replace(/<p><\/p>/g,"")).replace(/<p>(<h[123]>)/g,"$1")).replace(/(<\/h[123]>)<\/p>/g,"$1")).replace(/<p>(<pre>)/g,"$1")).replace(/(<\/pre>)<\/p>/g,"$1")).replace(/<p>(<ul>)/g,"$1")).replace(/(<\/ul>)<\/p>/g,"$1")}(e):o.textContent=e,r.appendChild(o),t.appendChild(r),t.scrollTop=t.scrollHeight}function H(e){var n=document.getElementById("chat-container"),t=document.createElement("div");t.className="message message-chart";var r=document.createElement("div");r.className="chart-container";var o="plotly-chart-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);try{var a=(new DOMParser).parseFromString(e,"text/html"),c=a.querySelector('div[id^="plotly-chart"]')||a.querySelector("div");c?((c=c.cloneNode(!0)).id=o,r.appendChild(c),a.querySelectorAll("script").forEach(function(e){var n=e.textContent||"",t=document.createElement("script");e.src?t.src=e.src:(n=n.replace(new RegExp("plotly-chart","g"),o),t.textContent=n),r.appendChild(t),console.log("Added script for chart ID:",o)})):(r.innerHTML=e.replace(/plotly-chart/g,o),console.log("Plotly div not found, inserted raw HTML with updated ID:",o))}catch(n){console.error("Error parsing chart HTML:",n),r.innerHTML=e.replace(/plotly-chart/g,o)}t.appendChild(r),n.appendChild(t),n.scrollTop=n.scrollHeight}function _(e,n){var t=document.getElementById("status");t.textContent=e,t.className="status status-".concat(n)}function $(){document.getElementById("user-input").disabled=!1,document.getElementById("send-btn").disabled=!1}function M(){document.getElementById("user-input").disabled=!0,document.getElementById("send-btn").disabled=!0}function F(e){document.getElementById("loading").style.display=e?"flex":"none"}Office.onReady(function(e){e.host===Office.HostType.Excel&&(console.log("Office Add-in initialized"),function(){if(p=localStorage.getItem("userCredentials"),localStorage.getItem("username"),!p)return console.log("No credentials found, redirecting to login"),void(window.location.href="login.html");(function(){return f.apply(this,arguments)})().then(function(e){e?(console.log("Credentials valid, initializing app"),function(){m.apply(this,arguments)}()):(console.log("Credentials invalid, redirecting to login"),h())}).catch(function(e){console.error("Error verifying credentials:",e),h()})}())})}(),function(){"use strict";new URL(t(58394),t.b),new URL(t(98362),t.b)}()}();
//# sourceMappingURL=taskpane.js.map