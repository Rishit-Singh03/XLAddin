/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={58394:function(e,t,n){"use strict";e.exports=n.p+"ad5bbf8413316a51c70a.css"},98362:function(e,t,n){"use strict";e.exports=n.p+"assets/logo-filled.png"}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.m=e,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e}(),n.b=document.baseURI||self.location.href,function(){function e(){var n,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",c=o.toStringTag||"@@toStringTag";function s(e,o,a,c){var s=o&&o.prototype instanceof l?o:l,u=Object.create(s.prototype);return t(u,"_invoke",function(e,t,o){var a,c,s,l=0,u=o||[],d=!1,p={p:0,n:0,v:n,a:g,f:g.bind(n,4),d:function(e,t){return a=e,c=0,s=n,p.n=t,i}};function g(e,t){for(c=e,s=t,r=0;!d&&l&&!o&&r<u.length;r++){var o,a=u[r],g=p.p,f=a[2];e>3?(o=f===t)&&(s=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=n):a[0]<=g&&((o=e<2&&g<a[1])?(c=0,p.v=t,p.n=a[1]):g<f&&(o=e<3||a[0]>t||t>f)&&(a[4]=e,a[5]=t,p.n=f,c=0))}if(o||e>1)return i;throw d=!0,t}return function(o,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&g(u,f),c=u,s=f;(r=c<2?n:s)||!d;){a||(c?c<3?(c>1&&(p.n=-1),g(c,s)):p.n=s:p.v=s);try{if(l=2,a){if(c||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,c<2&&(c=0)}else 1===c&&(r=a.return)&&r.call(a),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=n}else if((r=(d=p.n<0)?s:e.call(t,p))!==i)break}catch(e){a=n,c=1,s=e}finally{l=1}}return{value:r,done:d}}}(e,a,c),!0),u}var i={};function l(){}function u(){}function d(){}r=Object.getPrototypeOf;var p=[][a]?r(r([][a]())):(t(r={},a,function(){return this}),r),g=d.prototype=l.prototype=Object.create(p);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,t(e,c,"GeneratorFunction")),e.prototype=Object.create(g),e}return u.prototype=d,t(g,"constructor",d),t(d,"constructor",u),u.displayName="GeneratorFunction",t(d,c,"GeneratorFunction"),t(g),t(g,c,"Generator"),t(g,a,function(){return this}),t(g,"toString",function(){return"[object Generator]"}),(e=function(){return{w:s,m:f}})()}function t(e,n,r,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}t=function(e,n,r,o){function c(n,r){t(e,n,function(e){return this._invoke(n,r,e)})}n?a?a(e,n,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[n]=r:(c("next",0),c("throw",1),c("return",2))},t(e,n,r,o)}function n(e,t,n,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void n(e)}s.done?t(i):Promise.resolve(i).then(r,o)}function r(e){return function(){var t=this,r=arguments;return new Promise(function(o,a){var c=e.apply(t,r);function s(e){n(c,o,a,s,i,"next",e)}function i(e){n(c,o,a,s,i,"throw",e)}s(void 0)})}}var o="https://insyncai.duckdns.org",a="InSync API",c=!1,s=!1,i=!1,l=null,u=[];function d(){return(d=r(e().m(function t(){return e().w(function(e){for(;;)switch(e.n){case 0:return p(),document.getElementById("send-btn").addEventListener("click",x),document.getElementById("user-input").addEventListener("keypress",function(e){"Enter"!==e.key||s||x()}),document.getElementById("clear-chat-btn").addEventListener("click",y),I("Welcome! I'll help you analyze your Excel data.","assistant"),e.n=1,b();case 1:return e.a(2)}},t)}))).apply(this,arguments)}function p(){var e=sessionStorage.getItem("chatSessionId"),t=sessionStorage.getItem("conversationHistory");if(e&&t){l=e;try{u=JSON.parse(t),console.log("Restored session: ".concat(l," with ").concat(u.length," messages")),h(),u.forEach(function(e){e.content&&e.role&&I(e.content,e.role)})}catch(e){console.error("Failed to restore history:",e),g()}}else g()}function g(){l="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),u=[],sessionStorage.setItem("chatSessionId",l),sessionStorage.setItem("conversationHistory",JSON.stringify([])),console.log("Created new session: ".concat(l)),h()}function f(e){if(!e||"string"!=typeof e)return"Processing error occurred. Please try again.";var t=e.toLowerCase();return t.includes("gemini")||t.includes("google")||t.includes("generative")||t.includes("model")||t.includes("api key")||t.includes("quota")||t.includes("rate limit")||t.includes("safety")||t.includes("blocked")||t.includes("function call")||t.includes("tool")?"InSync AI processing error. Please try again later or rephrasing your question.":t.includes("server")||t.includes("backend")||t.includes("fastapi")||t.includes("internal server error")||t.includes("500")||t.includes("503")||t.includes("timeout")?"Service temporarily unavailable. Please try again in a moment.":t.includes("network")||t.includes("connection")||t.includes("fetch")||t.includes("cors")||t.includes("refused")?"Connection error. Please check your network and try again.":t.includes("unauthorized")||t.includes("forbidden")||t.includes("401")||t.includes("403")?"Access denied. Please contact support.":t.includes("json")||t.includes("parse")||t.includes("syntax")||t.includes("invalid")?"Data processing error. Please try again.":t.includes("exception")||t.includes("traceback")||t.includes("error:")||t.includes("failed to")?"Processing error occurred. Please try again.":e.length>100?"InSync AI encountered an issue. Please try again later or rephrasing your question.":e}function h(){var e=document.getElementById("context-indicator");if(e){var t=u.length;t>0?(e.textContent="".concat(t," messages"),e.style.display="block"):e.style.display="none"}}function m(){try{sessionStorage.setItem("conversationHistory",JSON.stringify(u))}catch(e){console.error("Failed to save conversation history:",e)}}function y(){return v.apply(this,arguments)}function v(){return(v=r(e().m(function t(){var n,r,a,c,s;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,k("Clearing chat history...","info"),e.p=1,e.n=2,fetch("".concat(o,"/api/session/reset"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:l})});case 2:return n=e.v,e.n=3,n.json();case 3:r=e.v,console.log("Session reset:",r.message),console.log("Embeddings preserved:",r.embeddingsPreserved),e.n=5;break;case 4:e.p=4,c=e.v,console.warn("Could not reset server session:",c);case 5:document.getElementById("chat-container").innerHTML="",u=[],m(),h(),I("Chat history cleared. Embeddings preserved. How can I help you?","assistant"),k("Ready - Chat cleared","success"),e.n=7;break;case 6:e.p=6,s=e.v,console.error("Error clearing conversation:",s),a=f(s.message),k("Error: ".concat(a),"error");case 7:return e.a(2)}},t,null,[[1,4],[0,6]])}))).apply(this,arguments)}function b(){return w.apply(this,arguments)}function w(){return w=r(e().m(function t(){var n,s;return e().w(function(t){for(;;)switch(t.p=t.n){case 0:if(!i){t.n=1;break}return console.log("Embeddings already loaded, skipping..."),t.a(2);case 1:return t.p=1,k("Looking for InSync API sheet...","info"),t.n=2,Excel.run(function(){var t=r(e().m(function t(n){var r,s,u,d,p,g,h,m,y,v;return e().w(function(e){for(;;)switch(e.n){case 0:return(r=n.workbook.worksheets).load("items/name"),e.n=1,n.sync();case 1:if(s=r.items.find(function(e){return e.name===a})){e.n=2;break}throw new Error('Sheet "'.concat(a,'" not found. Please ensure you have a sheet named "').concat(a,'".'));case 2:return k("Reading InSync API sheet...","info"),(u=s.getUsedRange()).load(["values","address"]),e.n=3,n.sync();case 3:return d=u.values,p=u.address,console.log("Read ".concat(d.length," rows from ").concat(a)),g=d[6]||[],k("Creating embeddings...","info"),e.n=4,fetch("".concat(o,"/api/embeddings/create-from-data?session_id=").concat(l),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({worksheetName:a,data:d,headers:g,metadata:{totalRows:d.length,totalCols:g.length,address:p}})});case 4:if((h=e.v).ok){e.n=6;break}return e.n=5,h.json();case 5:throw m=e.v,y=m.detail||"Failed to create embeddings",new Error(f(y));case 6:return e.n=7,h.json();case 7:v=e.v,console.log("Embeddings created:",v),c=!0,i=!0,k("Ready! Loaded ".concat(v.lineItemCount," metrics, ").concat(v.columnCount," periods"),"success"),C(),I("I've loaded your InSync API data with ".concat(v.lineItemCount," line items and ").concat(v.columnCount," time periods. What would you like to know?"),"assistant");case 8:return e.a(2)}},t)}));return function(e){return t.apply(this,arguments)}}());case 2:t.n=4;break;case 3:t.p=3,s=t.v,console.error("Error loading sheet:",s),k("Failed to load data","error"),n=f(s.message),I("Error: ".concat(n),"error");case 4:return t.a(2)}},t,null,[[1,3]])})),w.apply(this,arguments)}function x(){return E.apply(this,arguments)}function E(){return(E=r(e().m(function t(){var n,r,i,d,p,g,y,v,b,w,x;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!s&&c){e.n=1;break}return e.a(2);case 1:if(n=document.getElementById("user-input"),r=n.value.trim()){e.n=2;break}return e.a(2);case 2:return n.value="",I(r,"user"),i={role:"user",content:r,timestamp:Date.now()},u.push(i),m(),h(),s=!0,$(),P(!0),k("Analyzing...","info"),e.p=3,d=document.getElementById("chart-toggle").checked,console.log("ðŸ“Š Charts toggle state: ".concat(d)),e.n=4,fetch("".concat(o,"/api/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:r,sessionId:l,excelData:{worksheetName:a,data:[],headers:[]},conversationHistory:u,enableCharts:d})});case 4:if((p=e.v).ok){e.n=6;break}return e.n=5,p.json();case 5:throw g=e.v,y=g.detail||"Request failed",new Error(f(y));case 6:return e.n=7,p.json();case 7:v=e.v,console.log("Response:",v),I(v.answer,"assistant"),b={role:"assistant",content:v.answer,timestamp:Date.now(),hasChart:v.hasChart||!1},u.push(b),m(),h(),v.hasChart&&v.chartHtml&&S(v.chartHtml),void 0!==v.contextLength&&console.log("Server context length: ".concat(v.contextLength," messages")),k("Ready","success"),e.n=9;break;case 8:e.p=8,x=e.v,console.error("Error:",x),w=f(x.message),I("Error: ".concat(w),"error"),k("Error occurred","error");case 9:return e.p=9,s=!1,C(),P(!1),n.focus(),e.f(9);case 10:return e.a(2)}},t,null,[[3,8,9,10]])}))).apply(this,arguments)}function I(e,t){var n=document.getElementById("chat-container"),r=document.createElement("div");r.className="message message-".concat(t);var o=document.createElement("div");o.className="message-content","assistant"===t?o.innerHTML=function(e){var t=e;return t=t.replace(/```(\w+)?\n([\s\S]*?)```/g,function(e,t,n){return'<pre><code class="language-'.concat(t||"text",'">').concat(function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}(n.trim()),"</code></pre>")}),t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/`([^`]+)`/g,"<code>$1</code>")).replace(/\*\*([^*]+?)\*\*/g,"<strong>$1</strong>")).replace(/__([^_]+?)__/g,"<strong>$1</strong>")).replace(/(\s|^)\*([^\s*][^*]*?)\*(\s|$|[.,!?;:])/g,"$1<em>$2</em>$3")).replace(/(\s|^)_([^\s_][^_]*?)_(\s|$|[.,!?;:])/g,"$1<em>$2</em>$3")).replace(/^### (.+)$/gm,"<h3>$1</h3>")).replace(/^## (.+)$/gm,"<h2>$1</h2>")).replace(/^# (.+)$/gm,"<h1>$1</h1>")).replace(/^\* (.+)$/gm,"<li>$1</li>")).replace(/^- (.+)$/gm,"<li>$1</li>")).replace(/(<li>.*<\/li>\n?)+/g,function(e){return"<ul>".concat(e,"</ul>")})).replace(/^\d+\. (.+)$/gm,"<li>$1</li>")).replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>')).replace(/\n\n/g,"</p><p>")).replace(/\n/g,"<br>"),(t=(t=(t=(t=(t=(t=(t="<p>".concat(t,"</p>")).replace(/<p><\/p>/g,"")).replace(/<p>(<h[123]>)/g,"$1")).replace(/(<\/h[123]>)<\/p>/g,"$1")).replace(/<p>(<pre>)/g,"$1")).replace(/(<\/pre>)<\/p>/g,"$1")).replace(/<p>(<ul>)/g,"$1")).replace(/(<\/ul>)<\/p>/g,"$1")}(e):o.textContent=e,r.appendChild(o),n.appendChild(r),n.scrollTop=n.scrollHeight}function S(e){var t=document.getElementById("chat-container"),n=document.createElement("div");n.className="message message-chart";var r=document.createElement("div");r.className="chart-container";var o="plotly-chart-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);try{var a=(new DOMParser).parseFromString(e,"text/html"),c=a.querySelector('div[id^="plotly-chart"]')||a.querySelector("div");c?((c=c.cloneNode(!0)).id=o,r.appendChild(c),a.querySelectorAll("script").forEach(function(e){var t=e.textContent||"",n=document.createElement("script");e.src?n.src=e.src:(t=t.replace(new RegExp("plotly-chart","g"),o),n.textContent=t),r.appendChild(n),console.log("Added script for chart ID:",o)})):(r.innerHTML=e.replace(/plotly-chart/g,o),console.log("Plotly div not found, inserted raw HTML with updated ID:",o))}catch(t){console.error("Error parsing chart HTML:",t),r.innerHTML=e.replace(/plotly-chart/g,o)}n.appendChild(r),t.appendChild(n),t.scrollTop=t.scrollHeight}function k(e,t){var n=document.getElementById("status");n.textContent=e,n.className="status status-".concat(t)}function C(){document.getElementById("user-input").disabled=!1,document.getElementById("send-btn").disabled=!1}function $(){document.getElementById("user-input").disabled=!0,document.getElementById("send-btn").disabled=!0}function P(e){document.getElementById("loading").style.display=e?"flex":"none"}Office.onReady(function(e){e.host===Office.HostType.Excel&&(console.log("Office Add-in initialized"),function(){d.apply(this,arguments)}())})}(),function(){"use strict";new URL(n(58394),n.b),new URL(n(98362),n.b)}()}();
//# sourceMappingURL=taskpane.js.map