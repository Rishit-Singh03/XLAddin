/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={58394:function(e,n,t){"use strict";e.exports=t.p+"ad5bbf8413316a51c70a.css"},98362:function(e,n,t){"use strict";e.exports=t.p+"assets/logo-filled.png"}},n={};function t(r){var o=n[r];if(void 0!==o)return o.exports;var a=n[r]={exports:{}};return e[r](a,a.exports,t),a.exports}t.m=e,t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},function(){var e;t.g.importScripts&&(e=t.g.location+"");var n=t.g.document;if(!e&&n&&(n.currentScript&&"SCRIPT"===n.currentScript.tagName.toUpperCase()&&(e=n.currentScript.src),!e)){var r=n.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e}(),t.b=document.baseURI||self.location.href,function(){function e(){var t,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",c=o.toStringTag||"@@toStringTag";function s(e,o,a,c){var s=o&&o.prototype instanceof l?o:l,u=Object.create(s.prototype);return n(u,"_invoke",function(e,n,o){var a,c,s,l=0,u=o||[],d=!1,p={p:0,n:0,v:t,a:g,f:g.bind(t,4),d:function(e,n){return a=e,c=0,s=t,p.n=n,i}};function g(e,n){for(c=e,s=n,r=0;!d&&l&&!o&&r<u.length;r++){var o,a=u[r],g=p.p,f=a[2];e>3?(o=f===n)&&(s=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=t):a[0]<=g&&((o=e<2&&g<a[1])?(c=0,p.v=n,p.n=a[1]):g<f&&(o=e<3||a[0]>n||n>f)&&(a[4]=e,a[5]=n,p.n=f,c=0))}if(o||e>1)return i;throw d=!0,n}return function(o,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&g(u,f),c=u,s=f;(r=c<2?t:s)||!d;){a||(c?c<3?(c>1&&(p.n=-1),g(c,s)):p.n=s:p.v=s);try{if(l=2,a){if(c||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,c<2&&(c=0)}else 1===c&&(r=a.return)&&r.call(a),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=t}else if((r=(d=p.n<0)?s:e.call(n,p))!==i)break}catch(e){a=t,c=1,s=e}finally{l=1}}return{value:r,done:d}}}(e,a,c),!0),u}var i={};function l(){}function u(){}function d(){}r=Object.getPrototypeOf;var p=[][a]?r(r([][a]())):(n(r={},a,function(){return this}),r),g=d.prototype=l.prototype=Object.create(p);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,n(e,c,"GeneratorFunction")),e.prototype=Object.create(g),e}return u.prototype=d,n(g,"constructor",d),n(d,"constructor",u),u.displayName="GeneratorFunction",n(d,c,"GeneratorFunction"),n(g),n(g,c,"Generator"),n(g,a,function(){return this}),n(g,"toString",function(){return"[object Generator]"}),(e=function(){return{w:s,m:f}})()}function n(e,t,r,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}n=function(e,t,r,o){function c(t,r){n(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[t]=r:(c("next",0),c("throw",1),c("return",2))},n(e,t,r,o)}function t(e,n,t,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void t(e)}s.done?n(i):Promise.resolve(i).then(r,o)}function r(e){return function(){var n=this,r=arguments;return new Promise(function(o,a){var c=e.apply(n,r);function s(e){t(c,o,a,s,i,"next",e)}function i(e){t(c,o,a,s,i,"throw",e)}s(void 0)})}}var o="https://insyncai.duckdns.org ",a="InSync API",c=!1,s=!1,i=!1,l=null,u=[];function d(){return(d=r(e().m(function n(){return e().w(function(e){for(;;)switch(e.n){case 0:return p(),document.getElementById("send-btn").addEventListener("click",x),document.getElementById("user-input").addEventListener("keypress",function(e){"Enter"!==e.key||s||x()}),document.getElementById("clear-chat-btn").addEventListener("click",y),k("Welcome! I'll help you analyze your Excel data.","assistant"),e.n=1,b();case 1:return e.a(2)}},n)}))).apply(this,arguments)}function p(){var e=sessionStorage.getItem("chatSessionId"),n=sessionStorage.getItem("conversationHistory");if(e&&n){l=e;try{u=JSON.parse(n),console.log("Restored session: ".concat(l," with ").concat(u.length," messages")),h(),u.forEach(function(e){e.content&&e.role&&k(e.content,e.role)})}catch(e){console.error("Failed to restore history:",e),g()}}else g()}function g(){l="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"===e?n:3&n|8).toString(16)}),u=[],sessionStorage.setItem("chatSessionId",l),sessionStorage.setItem("conversationHistory",JSON.stringify([])),console.log("Created new session: ".concat(l)),h()}function f(e){if(!e||"string"!=typeof e)return"Processing error occurred. Please try again.";var n=e.toLowerCase();return n.includes("gemini")||n.includes("google")||n.includes("generative")||n.includes("model")||n.includes("api key")||n.includes("quota")||n.includes("rate limit")||n.includes("safety")||n.includes("blocked")||n.includes("function call")||n.includes("tool")?"InSync AI processing error. Please try again later or rephrasing your question.":n.includes("server")||n.includes("backend")||n.includes("fastapi")||n.includes("internal server error")||n.includes("500")||n.includes("503")||n.includes("timeout")?"Service temporarily unavailable. Please try again in a moment.":n.includes("network")||n.includes("connection")||n.includes("fetch")||n.includes("cors")||n.includes("refused")?"Connection error. Please check your network and try again.":n.includes("unauthorized")||n.includes("forbidden")||n.includes("401")||n.includes("403")?"Access denied. Please contact support.":n.includes("json")||n.includes("parse")||n.includes("syntax")||n.includes("invalid")?"Data processing error. Please try again.":n.includes("exception")||n.includes("traceback")||n.includes("error:")||n.includes("failed to")?"Processing error occurred. Please try again.":e.length>100?"InSync AI encountered an issue. Please try again later or rephrasing your question.":e}function h(){var e=document.getElementById("context-indicator");if(e){var n=u.length;n>0?(e.textContent="".concat(n," messages"),e.style.display="block"):e.style.display="none"}}function m(){try{sessionStorage.setItem("conversationHistory",JSON.stringify(u))}catch(e){console.error("Failed to save conversation history:",e)}}function y(){return v.apply(this,arguments)}function v(){return(v=r(e().m(function n(){var t,r,a,c,s;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,S("Clearing chat history...","info"),e.p=1,e.n=2,fetch("".concat(o,"/api/session/reset"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:l})});case 2:return t=e.v,e.n=3,t.json();case 3:r=e.v,console.log("Session reset:",r.message),console.log("Embeddings preserved:",r.embeddingsPreserved),e.n=5;break;case 4:e.p=4,c=e.v,console.warn("Could not reset server session:",c);case 5:document.getElementById("chat-container").innerHTML="",u=[],m(),h(),k("Chat history cleared. Embeddings preserved. How can I help you?","assistant"),S("Ready - Chat cleared","success"),e.n=7;break;case 6:e.p=6,s=e.v,console.error("Error clearing conversation:",s),a=f(s.message),S("Error: ".concat(a),"error");case 7:return e.a(2)}},n,null,[[1,4],[0,6]])}))).apply(this,arguments)}function b(){return w.apply(this,arguments)}function w(){return w=r(e().m(function n(){var t,s;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:if(!i){n.n=1;break}return console.log("Embeddings already loaded, skipping..."),n.a(2);case 1:return n.p=1,S("Looking for sheets...","info"),n.n=2,Excel.run(function(){var n=r(e().m(function n(t){var r,s,u,d,p,g,h,m,y,v,b,w,x;return e().w(function(e){for(;;)switch(e.n){case 0:return(r=t.workbook.worksheets).load("items/name"),e.n=1,t.sync();case 1:if(s=r.items.find(function(e){return e.name===a})){e.n=2;break}throw new Error('Sheet "'.concat(a,'" not found. Please ensure you have a sheet named "').concat(a,'".'));case 2:if(u=r.items.find(function(e){return"Model"===e.name}),d=null,!u){e.n=4;break}return S("Reading ticker from Model sheet...","info"),(p=u.getRange("A1")).load("values"),e.n=3,t.sync();case 3:(d=p.values[0][0])&&"string"==typeof d&&""!==d.trim()?(d=d.trim().toUpperCase(),console.log("Found ticker: ".concat(d))):(d=null,console.log("No ticker found in Model!A1")),e.n=5;break;case 4:console.log("Model sheet not found, proceeding without ticker");case 5:return S("Reading InSync API sheet...","info"),(g=s.getUsedRange()).load(["values","address"]),e.n=6,t.sync();case 6:return h=g.values,m=g.address,console.log("Read ".concat(h.length," rows from ").concat(a)),y=h[6]||[],S(d?"Checking for pre-built embeddings (".concat(d,")..."):"Creating embeddings...","info"),e.n=7,fetch("".concat(o,"/api/embeddings/create-from-data?session_id=").concat(l),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({worksheetName:a,data:h,headers:y,ticker:d,metadata:{totalRows:h.length,totalCols:y.length,address:m}})});case 7:if((v=e.v).ok){e.n=9;break}return e.n=8,v.json();case 8:throw b=e.v,w=b.detail||"Failed to create embeddings",new Error(f(w));case 9:return e.n=10,v.json();case 10:x=e.v,console.log("Embeddings result:",x),c=!0,i=!0,S("Ready! Loaded ".concat(x.lineItemCount," metrics, ").concat(x.columnCount," periods"),"success"),k("I've loaded your InSync API data with ".concat(x.lineItemCount," line items and ").concat(x.columnCount," time periods. What would you like to know?"),"assistant"),C();case 11:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 2:n.n=4;break;case 3:n.p=3,s=n.v,console.error("Error loading sheet:",s),S("Failed to load data","error"),t=f(s.message),k("Error: ".concat(t),"error");case 4:return n.a(2)}},n,null,[[1,3]])})),w.apply(this,arguments)}function x(){return E.apply(this,arguments)}function E(){return(E=r(e().m(function n(){var t,r,i,d,p,g,y,v,b,w,x;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!s&&c){e.n=1;break}return e.a(2);case 1:if(t=document.getElementById("user-input"),r=t.value.trim()){e.n=2;break}return e.a(2);case 2:return t.value="",k(r,"user"),i={role:"user",content:r,timestamp:Date.now()},u.push(i),m(),h(),s=!0,$(),P(!0),S("Analyzing...","info"),e.p=3,d=document.getElementById("chart-toggle").checked,console.log("ðŸ“Š Charts toggle state: ".concat(d)),e.n=4,fetch("".concat(o,"/api/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:r,sessionId:l,excelData:{worksheetName:a,data:[],headers:[]},conversationHistory:u,enableCharts:d})});case 4:if((p=e.v).ok){e.n=6;break}return e.n=5,p.json();case 5:throw g=e.v,y=g.detail||"Request failed",new Error(f(y));case 6:return e.n=7,p.json();case 7:v=e.v,console.log("Response:",v),k(v.answer,"assistant"),b={role:"assistant",content:v.answer,timestamp:Date.now(),hasChart:v.hasChart||!1},u.push(b),m(),h(),v.hasChart&&v.chartHtml&&I(v.chartHtml),void 0!==v.contextLength&&console.log("Server context length: ".concat(v.contextLength," messages")),S("Ready","success"),e.n=9;break;case 8:e.p=8,x=e.v,console.error("Error:",x),w=f(x.message),k("Error: ".concat(w),"error"),S("Error occurred","error");case 9:return e.p=9,s=!1,C(),P(!1),t.focus(),e.f(9);case 10:return e.a(2)}},n,null,[[3,8,9,10]])}))).apply(this,arguments)}function k(e,n){var t=document.getElementById("chat-container"),r=document.createElement("div");r.className="message message-".concat(n);var o=document.createElement("div");o.className="message-content";var a=e;try{"string"==typeof e&&e.includes("Ãƒ")&&(a=e.replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Å“/g,"â€”").replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬/g,"â€“").replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢/g,"â€¢").replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦/g,"â€¦").replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…"/g,'"').replace(/ÃƒÂ¢Ã¢â€šÂ¬\u009D/g,'"').replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢/g,"'").replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã‹Å“/g,"'"))}catch(e){console.warn("Error cleaning text encoding:",e)}"assistant"===n?o.innerHTML=function(e){var n=e;return n=n.replace(/```(\w+)?\n([\s\S]*?)```/g,function(e,n,t){return'<pre><code class="language-'.concat(n||"text",'">').concat(function(e){var n=document.createElement("div");return n.textContent=e,n.innerHTML}(t.trim()),"</code></pre>")}),n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=(n=n.replace(/`([^`]+)`/g,"<code>$1</code>")).replace(/\*\*([^*]+?)\*\*/g,"<strong>$1</strong>")).replace(/__([^_]+?)__/g,"<strong>$1</strong>")).replace(/(\s|^)\*([^\s*][^*]*?)\*(\s|$|[.,!?;:])/g,"$1<em>$2</em>$3")).replace(/(\s|^)_([^\s_][^_]*?)_(\s|$|[.,!?;:])/g,"$1<em>$2</em>$3")).replace(/^### (.+)$/gm,"<h3>$1</h3>")).replace(/^## (.+)$/gm,"<h2>$1</h2>")).replace(/^# (.+)$/gm,"<h1>$1</h1>")).replace(/^\* (.+)$/gm,"<li>$1</li>")).replace(/^- (.+)$/gm,"<li>$1</li>")).replace(/(<li>.*<\/li>\n?)+/g,function(e){return"<ul>".concat(e,"</ul>")})).replace(/^\d+\. (.+)$/gm,"<li>$1</li>")).replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>')).replace(/\n\n/g,"</p><p>")).replace(/\n/g,"<br>"),(n=(n=(n=(n=(n=(n=(n="<p>".concat(n,"</p>")).replace(/<p><\/p>/g,"")).replace(/<p>(<h[123]>)/g,"$1")).replace(/(<\/h[123]>)<\/p>/g,"$1")).replace(/<p>(<pre>)/g,"$1")).replace(/(<\/pre>)<\/p>/g,"$1")).replace(/<p>(<ul>)/g,"$1")).replace(/(<\/ul>)<\/p>/g,"$1")}(a):o.textContent=a,r.appendChild(o),t.appendChild(r),t.scrollTop=t.scrollHeight}function I(e){var n=document.getElementById("chat-container"),t=document.createElement("div");t.className="message message-chart";var r=document.createElement("div");r.className="chart-container";var o="plotly-chart-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);try{var a=(new DOMParser).parseFromString(e,"text/html"),c=a.querySelector('div[id^="plotly-chart"]')||a.querySelector("div");c?((c=c.cloneNode(!0)).id=o,r.appendChild(c),a.querySelectorAll("script").forEach(function(e){var n=e.textContent||"",t=document.createElement("script");e.src?t.src=e.src:(n=n.replace(new RegExp("plotly-chart","g"),o),t.textContent=n),r.appendChild(t),console.log("Added script for chart ID:",o)})):(r.innerHTML=e.replace(/plotly-chart/g,o),console.log("Plotly div not found, inserted raw HTML with updated ID:",o))}catch(n){console.error("Error parsing chart HTML:",n),r.innerHTML=e.replace(/plotly-chart/g,o)}t.appendChild(r),n.appendChild(t),n.scrollTop=n.scrollHeight}function S(e,n){var t=document.getElementById("status");t.textContent=e,t.className="status status-".concat(n)}function C(){document.getElementById("user-input").disabled=!1,document.getElementById("send-btn").disabled=!1}function $(){document.getElementById("user-input").disabled=!0,document.getElementById("send-btn").disabled=!0}function P(e){document.getElementById("loading").style.display=e?"flex":"none"}Office.onReady(function(e){e.host===Office.HostType.Excel&&(console.log("Office Add-in initialized"),function(){d.apply(this,arguments)}())})}(),function(){"use strict";new URL(t(58394),t.b),new URL(t(98362),t.b)}()}();
//# sourceMappingURL=taskpane.js.map