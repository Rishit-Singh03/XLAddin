/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={58394:function(e,n,t){"use strict";e.exports=t.p+"dd158abd204432402792.css"},98362:function(e,n,t){"use strict";e.exports=t.p+"assets/logo-filled.png"}},n={};function t(r){var o=n[r];if(void 0!==o)return o.exports;var c=n[r]={exports:{}};return e[r](c,c.exports,t),c.exports}t.m=e,t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},function(){var e;t.g.importScripts&&(e=t.g.location+"");var n=t.g.document;if(!e&&n&&(n.currentScript&&"SCRIPT"===n.currentScript.tagName.toUpperCase()&&(e=n.currentScript.src),!e)){var r=n.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e}(),t.b=document.baseURI||self.location.href,function(){function e(){var t,r,o="function"==typeof Symbol?Symbol:{},c=o.iterator||"@@iterator",a=o.toStringTag||"@@toStringTag";function s(e,o,c,a){var s=o&&o.prototype instanceof l?o:l,u=Object.create(s.prototype);return n(u,"_invoke",function(e,n,o){var c,a,s,l=0,u=o||[],d=!1,p={p:0,n:0,v:t,a:f,f:f.bind(t,4),d:function(e,n){return c=e,a=0,s=t,p.n=n,i}};function f(e,n){for(a=e,s=n,r=0;!d&&l&&!o&&r<u.length;r++){var o,c=u[r],f=p.p,g=c[2];e>3?(o=g===n)&&(s=c[(a=c[4])?5:(a=3,3)],c[4]=c[5]=t):c[0]<=f&&((o=e<2&&f<c[1])?(a=0,p.v=n,p.n=c[1]):f<g&&(o=e<3||c[0]>n||n>g)&&(c[4]=e,c[5]=n,p.n=g,a=0))}if(o||e>1)return i;throw d=!0,n}return function(o,u,g){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,g),a=u,s=g;(r=a<2?t:s)||!d;){c||(a?a<3?(a>1&&(p.n=-1),f(a,s)):p.n=s:p.v=s);try{if(l=2,c){if(a||(o="next"),r=c[o]){if(!(r=r.call(c,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,a<2&&(a=0)}else 1===a&&(r=c.return)&&r.call(c),a<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),a=1);c=t}else if((r=(d=p.n<0)?s:e.call(n,p))!==i)break}catch(e){c=t,a=1,s=e}finally{l=1}}return{value:r,done:d}}}(e,c,a),!0),u}var i={};function l(){}function u(){}function d(){}r=Object.getPrototypeOf;var p=[][c]?r(r([][c]())):(n(r={},c,function(){return this}),r),f=d.prototype=l.prototype=Object.create(p);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,n(e,a,"GeneratorFunction")),e.prototype=Object.create(f),e}return u.prototype=d,n(f,"constructor",d),n(d,"constructor",u),u.displayName="GeneratorFunction",n(d,a,"GeneratorFunction"),n(f),n(f,a,"Generator"),n(f,c,function(){return this}),n(f,"toString",function(){return"[object Generator]"}),(e=function(){return{w:s,m:g}})()}function n(e,t,r,o){var c=Object.defineProperty;try{c({},"",{})}catch(e){c=0}n=function(e,t,r,o){function a(t,r){n(e,t,function(e){return this._invoke(t,r,e)})}t?c?c(e,t,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},n(e,t,r,o)}function t(e,n,t,r,o,c,a){try{var s=e[c](a),i=s.value}catch(e){return void t(e)}s.done?n(i):Promise.resolve(i).then(r,o)}function r(e){return function(){var n=this,r=arguments;return new Promise(function(o,c){var a=e.apply(n,r);function s(e){t(a,o,c,s,i,"next",e)}function i(e){t(a,o,c,s,i,"throw",e)}s(void 0)})}}var o="http://localhost:8000",c="InSync API",a=!1,s=!1,i=!1,l=null,u=[];function d(){return(d=r(e().m(function n(){return e().w(function(e){for(;;)switch(e.n){case 0:return p(),document.getElementById("send-btn").addEventListener("click",x),document.getElementById("user-input").addEventListener("keypress",function(e){"Enter"!==e.key||s||x()}),document.getElementById("clear-chat-btn").addEventListener("click",y),k("Welcome! I'll help you analyze your Excel data.","assistant"),e.n=1,b();case 1:return e.a(2)}},n)}))).apply(this,arguments)}function p(){var e=sessionStorage.getItem("chatSessionId"),n=sessionStorage.getItem("conversationHistory");if(e&&n){l=e;try{u=JSON.parse(n),console.log("Restored session: ".concat(l," with ").concat(u.length," messages")),h(),u.forEach(function(e){e.content&&e.role&&k(e.content,e.role)})}catch(e){console.error("Failed to restore history:",e),f()}}else f()}function f(){l="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"===e?n:3&n|8).toString(16)}),u=[],sessionStorage.setItem("chatSessionId",l),sessionStorage.setItem("conversationHistory",JSON.stringify([])),console.log("Created new session: ".concat(l)),h()}function g(e){if(!e||"string"!=typeof e)return"Processing error occurred. Please try again.";var n=e.toLowerCase();return n.includes("gemini")||n.includes("google")||n.includes("generative")||n.includes("model")||n.includes("api key")||n.includes("quota")||n.includes("rate limit")||n.includes("safety")||n.includes("blocked")||n.includes("function call")||n.includes("tool")?"InSync AI processing error. Please try again later or rephrasing your question.":n.includes("server")||n.includes("backend")||n.includes("fastapi")||n.includes("internal server error")||n.includes("500")||n.includes("503")||n.includes("timeout")?"Service temporarily unavailable. Please try again in a moment.":n.includes("network")||n.includes("connection")||n.includes("fetch")||n.includes("cors")||n.includes("refused")?"Connection error. Please check your network and try again.":n.includes("unauthorized")||n.includes("forbidden")||n.includes("401")||n.includes("403")?"Access denied. Please contact support.":n.includes("json")||n.includes("parse")||n.includes("syntax")||n.includes("invalid")?"Data processing error. Please try again.":n.includes("exception")||n.includes("traceback")||n.includes("error:")||n.includes("failed to")?"Processing error occurred. Please try again.":e.length>100?"InSync AI encountered an issue. Please try again later or rephrasing your question.":e}function h(){var e=document.getElementById("context-indicator");if(e){var n=u.length;n>0?(e.textContent="".concat(n," messages"),e.style.display="block"):e.style.display="none"}}function m(){try{sessionStorage.setItem("conversationHistory",JSON.stringify(u))}catch(e){console.error("Failed to save conversation history:",e)}}function y(){return v.apply(this,arguments)}function v(){return(v=r(e().m(function n(){var t,r,c,a,s;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,S("Clearing chat history...","info"),e.p=1,e.n=2,fetch("".concat(o,"/api/session/reset"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:l})});case 2:return t=e.v,e.n=3,t.json();case 3:r=e.v,console.log("Session reset:",r.message),console.log("Embeddings preserved:",r.embeddingsPreserved),e.n=5;break;case 4:e.p=4,a=e.v,console.warn("Could not reset server session:",a);case 5:document.getElementById("chat-container").innerHTML="",u=[],m(),h(),k("Chat history cleared. Embeddings preserved. How can I help you?","assistant"),S("Ready - Chat cleared","success"),e.n=7;break;case 6:e.p=6,s=e.v,console.error("Error clearing conversation:",s),c=g(s.message),S("Error: ".concat(c),"error");case 7:return e.a(2)}},n,null,[[1,4],[0,6]])}))).apply(this,arguments)}function b(){return w.apply(this,arguments)}function w(){return w=r(e().m(function n(){var t,s;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:if(!i){n.n=1;break}return console.log("Embeddings already loaded, skipping..."),n.a(2);case 1:return n.p=1,S("Looking for sheets...","info"),n.n=2,Excel.run(function(){var n=r(e().m(function n(t){var r,s,u,d,p,f,h,m,y,v,b,w,x;return e().w(function(e){for(;;)switch(e.n){case 0:return(r=t.workbook.worksheets).load("items/name"),e.n=1,t.sync();case 1:if(s=r.items.find(function(e){return e.name===c})){e.n=2;break}throw new Error('Sheet "'.concat(c,'" not found. Please ensure you have a sheet named "').concat(c,'".'));case 2:if(u=r.items.find(function(e){return"Model"===e.name}),d=null,!u){e.n=4;break}return S("Reading ticker from Model sheet...","info"),(p=u.getRange("A1")).load("values"),e.n=3,t.sync();case 3:(d=p.values[0][0])&&"string"==typeof d&&""!==d.trim()?(d=d.trim().toUpperCase(),console.log("Found ticker: ".concat(d))):(d=null,console.log("No ticker found in Model!A1")),e.n=5;break;case 4:console.log("Model sheet not found, proceeding without ticker");case 5:return S("Reading InSync API sheet...","info"),(f=s.getUsedRange()).load(["values","address"]),e.n=6,t.sync();case 6:return h=f.values,m=f.address,console.log("Read ".concat(h.length," rows from ").concat(c)),y=h[6]||[],S(d?"Checking for pre-built embeddings (".concat(d,")..."):"Creating embeddings...","info"),e.n=7,fetch("".concat(o,"/api/embeddings/create-from-data?session_id=").concat(l),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({worksheetName:c,data:h,headers:y,ticker:d,metadata:{totalRows:h.length,totalCols:y.length,address:m}})});case 7:if((v=e.v).ok){e.n=9;break}return e.n=8,v.json();case 8:throw b=e.v,w=b.detail||"Failed to create embeddings",new Error(g(w));case 9:return e.n=10,v.json();case 10:x=e.v,console.log("Embeddings result:",x),a=!0,i=!0,S("Ready! Loaded ".concat(x.lineItemCount," metrics, ").concat(x.columnCount," periods"),"success"),k("I've loaded your InSync API data with ".concat(x.lineItemCount," line items and ").concat(x.columnCount," time periods. What would you like to know?"),"assistant"),C();case 11:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 2:n.n=4;break;case 3:n.p=3,s=n.v,console.error("Error loading sheet:",s),S("Failed to load data","error"),t=g(s.message),k("Error: ".concat(t),"error");case 4:return n.a(2)}},n,null,[[1,3]])})),w.apply(this,arguments)}function x(){return E.apply(this,arguments)}function E(){return(E=r(e().m(function n(){var t,r,i,d,p,f,y,v,b,w,x;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!s&&a){e.n=1;break}return e.a(2);case 1:if(t=document.getElementById("user-input"),r=t.value.trim()){e.n=2;break}return e.a(2);case 2:return t.value="",k(r,"user"),i={role:"user",content:r,timestamp:Date.now()},u.push(i),m(),h(),s=!0,P(),T(!0),S("Analyzing...","info"),e.p=3,d=document.getElementById("chart-toggle").checked,console.log("📊 Charts toggle state: ".concat(d)),e.n=4,fetch("".concat(o,"/api/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:r,sessionId:l,excelData:{worksheetName:c,data:[],headers:[]},conversationHistory:u,enableCharts:d})});case 4:if((p=e.v).ok){e.n=6;break}return e.n=5,p.json();case 5:throw f=e.v,y=f.detail||"Request failed",new Error(g(y));case 6:return e.n=7,p.json();case 7:v=e.v,console.log("Response:",v),k(v.answer,"assistant"),b={role:"assistant",content:v.answer,timestamp:Date.now(),hasChart:v.hasChart||!1},u.push(b),m(),h(),v.hasChart&&v.chartHtml&&I(v.chartHtml),void 0!==v.contextLength&&console.log("Server context length: ".concat(v.contextLength," messages")),S("Ready","success"),e.n=9;break;case 8:e.p=8,x=e.v,console.error("Error:",x),w=g(x.message),k("Error: ".concat(w),"error"),S("Error occurred","error");case 9:return e.p=9,s=!1,C(),T(!1),t.focus(),e.f(9);case 10:return e.a(2)}},n,null,[[3,8,9,10]])}))).apply(this,arguments)}function k(e,n){var t=document.getElementById("chat-container"),r=document.createElement("div");r.className="message message-".concat(n);var o=document.createElement("div");o.className="message-content","assistant"===n?o.innerHTML=function(e){var n=e;return n=n.replace(/```(\w+)?\n([\s\S]*?)```/g,function(e,n,t){return'<pre><code class="language-'.concat(n||"text",'">').concat(function(e){var n=document.createElement("div");return n.textContent=e,n.innerHTML}(t.trim()),"</code></pre>")}),n=(n=n.replace(/`([^`]+)`/g,function(e,n){return"<code>".concat(n,"</code>")})).replace(/\*\*([^*]+?)\*\*/g,function(e,n){return"<strong>".concat(n,"</strong>")}),n=n.replace(/__([^_]+?)__/g,function(e,n){return"<strong>".concat(n,"</strong>")}),n=n.replace(/(\s|^)\*([^\s*][^*]*?)\*(\s|$|[.,!?;:])/g,function(e,n,t,r){return"".concat(n,"<em>").concat(t,"</em>").concat(r)}),n=n.replace(/(\s|^)_([^\s_][^_]*?)_(\s|$|[.,!?;:])/g,function(e,n,t,r){return"".concat(n,"<em>").concat(t,"</em>").concat(r)}),n=n.replace(/^### (.+)$/gm,function(e,n){return"<h3>".concat(n,"</h3>")}),n=n.replace(/^## (.+)$/gm,function(e,n){return"<h2>".concat(n,"</h2>")}),n=n.replace(/^# (.+)$/gm,function(e,n){return"<h1>".concat(n,"</h1>")}),n=n.replace(/^\* (.+)$/gm,function(e,n){return"<li>".concat(n,"</li>")}),n=n.replace(/^- (.+)$/gm,function(e,n){return"<li>".concat(n,"</li>")}),n=(n=n.replace(/(<li>.*<\/li>\n?)+/g,function(e){return"<ul>".concat(e,"</ul>")})).replace(/^\d+\. (.+)$/gm,function(e,n){return"<li>".concat(n,"</li>")}),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,function(e,n,t){return'<a href="'.concat(t,'" target="_blank">').concat(n,"</a>")}),n=(n=n.replace(/\n\n/g,"</p><p>")).replace(/\n/g,"<br>"),(n=(n=(n=(n=(n=(n=(n="<p>".concat(n,"</p>")).replace(/<p><\/p>/g,"")).replace(/<p>(<h[123]>)/g,"$1")).replace(/(<\/h[123]>)<\/p>/g,"$1")).replace(/<p>(<pre>)/g,"$1")).replace(/(<\/pre>)<\/p>/g,"$1")).replace(/<p>(<ul>)/g,"$1")).replace(/(<\/ul>)<\/p>/g,"$1")}(e):o.textContent=e,r.appendChild(o),t.appendChild(r),t.scrollTop=t.scrollHeight}function I(e){var n=document.getElementById("chat-container"),t=document.createElement("div");t.className="message message-chart";var r=document.createElement("div");r.className="chart-container";var o="plotly-chart-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);try{var c=(new DOMParser).parseFromString(e,"text/html"),a=c.querySelector('div[id^="plotly-chart"]')||c.querySelector("div");a?((a=a.cloneNode(!0)).id=o,r.appendChild(a),c.querySelectorAll("script").forEach(function(e){var n=e.textContent||"",t=document.createElement("script");e.src?t.src=e.src:(n=n.replace(new RegExp("plotly-chart","g"),o),t.textContent=n),r.appendChild(t),console.log("Added script for chart ID:",o)})):(r.innerHTML=e.replace(/plotly-chart/g,o),console.log("Plotly div not found, inserted raw HTML with updated ID:",o))}catch(n){console.error("Error parsing chart HTML:",n),r.innerHTML=e.replace(/plotly-chart/g,o)}t.appendChild(r),n.appendChild(t),n.scrollTop=n.scrollHeight}function S(e,n){var t=document.getElementById("status");t.textContent=e,t.className="status status-".concat(n)}function C(){document.getElementById("user-input").disabled=!1,document.getElementById("send-btn").disabled=!1}function P(){document.getElementById("user-input").disabled=!0,document.getElementById("send-btn").disabled=!0}function T(e){document.getElementById("loading").style.display=e?"flex":"none"}Office.onReady(function(e){e.host===Office.HostType.Excel&&(console.log("Office Add-in initialized"),function(){d.apply(this,arguments)}())})}(),function(){"use strict";new URL(t(58394),t.b),new URL(t(98362),t.b)}()}();
//# sourceMappingURL=taskpane.js.map